<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oracle AI: La Finestra de Cúbic (Versió 404 Fix)</title>
    
    <!-- LLIBS DE CÀRREGA GLOBAL -->
    <!-- 1. THREE.js (Càrrega síncrona) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- 2. MEDIAPIPE: Es carregarà dinàmicament a checkDependencies. -->
    
    <style>
        /* La font VT323 és crucial per l'estètica cyberpunk */
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            color: #00ff77;
            font-family: 'VT323', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        canvas {
            display: block;
        }

        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            text-align: center;
            font-size: 1.5rem;
        }

        .spinner {
            border: 5px solid rgba(0, 255, 119, 0.3);
            border-top: 5px solid #00ff77;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #output-text {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 600px;
            background-color: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff77;
            padding: 10px;
            text-align: center;
            font-size: 1.2rem;
            box-shadow: 0 0 10px #00ff77;
        }

        #stats-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            border: 1px solid #00ff77;
            padding: 5px;
            font-size: 0.9rem;
            /* Flexbox per al nou element de versió */
            display: flex;
            flex-direction: column;
            gap: 5px;
            /* FIX: Assegura que es vegi sobre l'overlay de càrrega (z-index: 100) */
            z-index: 101; 
        }
        
        /* Estil per al segell de versió (debugging) */
        #version-stamp {
            font-size: 0.8rem;
            color: #00ff77; /* Mateix color que l'oracle */
            opacity: 0.7; /* Una mica transparent per ser menys invasiu */
            margin-top: 5px;
            border-top: 1px dashed rgba(0, 255, 119, 0.3);
            padding-top: 5px;
        }


        /* Estils per als elements d'interacció (Botons) */
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 10px;
            z-index: 101;
        }

        .control-button {
            background-color: #003311;
            color: #00ff77;
            border: 1px solid #00ff77;
            padding: 8px 15px;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 1rem;
            text-shadow: 0 0 5px #00ff77;
            box-shadow: 0 0 5px #00ff77;
            transition: background-color 0.2s, box-shadow 0.2s;
        }

        .control-button:hover {
            background-color: #005522;
            box-shadow: 0 0 15px #00ff77;
        }
    </style>
</head>
<body>

    <!-- Overlay de càrrega i missatge de permís de càmera -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="status-message">INICIALITZANT NUCLI NEURONAL . . .</div>
        <div id="camera-message">Si us plau, permet l'accés a la càmera</div>
    </div>

    <!-- Panell d'estadístiques -->
    <div id="stats-panel">
        <div>FPS: <span id="fps-value">N/A</span></div>
        <div>LATÈNCIA: <span id="latency-value">N/A</span> ms</div>
        <!-- Segell de versió (debugging) -->
        <div id="version-stamp"></div>
    </div>

    <!-- Botons de control -->
    <div id="controls">
        <button id="toggle-cubes" class="control-button">CUB: ON</button>
        <button id="toggle-webcam" class="control-button">WEBCAM: ON</button>
    </div>

    <!-- El contenidor del missatge d'output de l'IA -->
    <div id="output-text">
        Preparat per a la detecció visual. Mou els dits per obtenir respostes.
    </div>

    <!-- Vídeo i Canvas (s'afegiran dinàmicament) -->

    <script>
        // =================================================================
        // Variables Globals
        // =================================================================

        // Versió per a depuració: [vAAAAHHMM_HHmmss]
        const VERSION_STAMP = "v20251203-122400"; // Versió amb el fix del 404 
        
        let video, canvas, ctx, scene, camera, renderer;
        let cubeGroup; // Grup 3D per als cubs
        let cubeCount = 20;
        let lastTimestamp = 0;
        let fps = 0;
        let lastDetectionTime = 0;
        let recognitionLatency = 0;
        let recognizer;
        let isCubesVisible = true;
        let isWebcamVisible = true;
        
        // Nova variable per al mòdul MediaPipe (es carregarà dinàmicament)
        let mpVision = null; 

        // Configuració 3D
        const cameraZ = 25;

        // Colors de l'Oracle
        const ORACLE_COLOR = 0x00ff77; // Verd cibernètic
        const BACKGROUND_COLOR = 0x000000;

        // Gestos i Respostes
        const gestureResponses = {
            "Thumb_Up": "ACCEPTACIÓ: El nucli neuronal ho valida.",
            "Thumb_Down": "NEGACIÓ: Cal una reavaluació crítica.",
            "Open_Palm": "PAUSA: L'Oracle espera la vostra pregunta.",
            "Closed_Fist": "FOCUS: Concentra la teva voluntat.",
            "Pointing_Up": "INTERROGACIÓ: La resposta ascendeix.",
            "Victory": "DUALITAT: La veritat resideix entre dos extrems.",
            "ILoveYou": "CONNEXIÓ: Interfície emocional detectada."
        };

        // --- FUNCIONS AUXILIARS ---

        /**
         * Inicialitza l'escena 3D de Three.js.
         */
        function initThree() {
            // Escena
            scene = new THREE.Scene();
            scene.background = new THREE.Color(BACKGROUND_COLOR);

            // Càmera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = cameraZ;

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Llum
            const ambientLight = new THREE.AmbientLight(ORACLE_COLOR, 0.5);
            scene.add(ambientLight);

            const pointLight = new THREE.PointLight(ORACLE_COLOR, 2, 100);
            pointLight.position.set(0, 0, 10);
            scene.add(pointLight);

            // Grup per als cubs
            cubeGroup = new THREE.Group();
            scene.add(cubeGroup);

            // Crear i posicionar els cubs
            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const material = new THREE.MeshPhongMaterial({
                color: ORACLE_COLOR,
                wireframe: true,
                transparent: true,
                opacity: 0.8
            });

            for (let i = 0; i < cubeCount; i++) {
                const cube = new THREE.Mesh(geometry, material.clone());
                cube.position.set(
                    (Math.random() - 0.5) * 20,
                    (Math.random() - 0.5) * 20,
                    (Math.random() - 0.5) * 10
                );
                cube.rotation.set(Math.random() * 2 * Math.PI, Math.random() * 2 * Math.PI, Math.random() * 2 * Math.PI);
                cubeGroup.add(cube);
            }

            window.addEventListener('resize', onWindowResize);
        }

        /**
         * Redimensiona l'escena 3D i el vídeo quan la finestra canvia de mida.
         */
        function onWindowResize() {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
            if (video) {
                // Sincronitza la mida del canvas de vídeo amb la finestra per al fons
                video.style.width = window.innerWidth + 'px';
                video.style.height = window.innerHeight + 'px';
            }
        }

        /**
         * Mostra missatges a la pantalla.
         * @param {string} message - El missatge a mostrar.
         */
        function displayOutput(message) {
            const outputElement = document.getElementById('output-text');
            if (outputElement) {
                outputElement.textContent = message;
            }
        }

        // --- INICIALITZACIÓ DE LA IA (MEDIAPIPE) ---

        /**
         * Inicialitza l'eina de reconeixement de gestos utilitzant la variable global mpVision.
         */
        async function initAI() {
            // Aquesta comprovació ja hauria de passar checkDependencies, però per seguretat.
            if (!mpVision || typeof mpVision.FilesetResolver === 'undefined') {
                document.getElementById('status-message').textContent = "ERROR: Nucli IA no disponible (mpVision indefinit).";
                document.getElementById('camera-message').textContent = "S'ha interromput la inicialització IA.";
                document.querySelector('.spinner').style.display = 'none';
                console.error("CONSOLE_ERROR: Error càmera/IA: mpVision no conté les classes necessàries. S'ha interromput la inicialització IA.");
                return;
            }

            try {
                displayOutput("Carregant models de visió...");

                // Desestructuració des de la variable dinàmica (mpVision)
                const { FilesetResolver, GestureRecognizer } = mpVision;

                // 1. Inicialitza FilesetResolver per trobar els fitxers de tasques
                const fileset = await FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
                );

                // 2. Crea el reconeixedor de gestos
                recognizer = await GestureRecognizer.create(fileset, {
                    baseOptions: {
                        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/gesture_recognizer/gesture_recognizer/float16/1/gesture_recognizer.task",
                        delegate: "GPU" // Si està disponible
                    },
                    runningMode: "VIDEO"
                });

                displayOutput("Models neuronals carregats. Sol·licitant accés a la càmera...");
                
                // Un cop carregat, intenta iniciar la càmera
                initCamera();

            } catch (error) {
                console.error("CONSOLE_ERROR: Error càmera/IA: No es pot inicialitzar l'AI/MediaPipe. Detall:", error);
                document.getElementById('status-message').textContent = "ERROR: No es pot inicialitzar el nucli IA.";
                document.getElementById('camera-message').textContent = "Consulta la consola per a més detalls.";
                document.querySelector('.spinner').style.display = 'none';
            }
        }

        // --- CÀMERA I DETECCIÓ ---

        /**
         * Sol·licita l'accés a la càmera i inicia la transmissió.
         */
        function initCamera() {
            // Aquesta part és la que requereix un context segur (HTTPS) i permís explícit.
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then((stream) => {
                        // Oculta la pantalla de càrrega i mostra l'aplicació
                        document.getElementById('loading-overlay').style.display = 'none';

                        // Crea l'element de vídeo
                        video = document.createElement('video');
                        video.id = 'webcam-video';
                        video.style.position = 'absolute';
                        video.style.top = '0';
                        video.style.left = '0';
                        video.style.objectFit = 'cover';
                        video.style.zIndex = '-1';
                        video.style.transform = 'scaleX(-1)'; // Mirall
                        video.style.filter = 'grayscale(100%) brightness(0.5) contrast(1.5)';
                        video.style.display = isWebcamVisible ? 'block' : 'none';
                        document.body.appendChild(video);

                        // Assigna el flux i inicia la reproducció
                        video.srcObject = stream;
                        video.onloadedmetadata = () => {
                            video.play();
                            onWindowResize(); // Assegura que el vídeo ompli la pantalla
                            // Un cop el vídeo s'inicia, comencem l'animació
                            requestAnimationFrame(animate);
                        };
                    })
                    .catch((err) => {
                        console.error("CONSOLE_ERROR: Error en l'accés a la càmera. Això passa si l'entorn no és segur (no és HTTPS) o el permís ha estat denegat.", err);
                        document.getElementById('status-message').textContent = "ERROR D'ACCÉS A LA CÀMERA.";
                        document.getElementById('camera-message').textContent = "Assegureu-vos que utilitzeu HTTPS i que no heu denegat el permís. No es pot iniciar l'aplicació.";
                        // Amaga la roda de càrrega si falla
                        document.querySelector('.spinner').style.display = 'none';
                    });
            } else {
                console.error("CONSOLE_ERROR: getUserMedia no és compatible amb aquest navegador.");
                document.getElementById('status-message').textContent = "ERROR: Navegador no compatible amb la càmera.";
                document.querySelector('.spinner').style.display = 'none';
            }
        }

        /**
         * Executa el reconeixement de gestos i actualitza l'escena 3D.
         */
        function recognizeGestures() {
            if (recognizer && video && video.readyState === 4) {
                const startTimeMs = performance.now();
                // Utilitzem l'últim temps per optimitzar el processament
                const results = recognizer.recognizeForVideo(video, lastDetectionTime);
                const endTimeMs = performance.now();

                lastDetectionTime = endTimeMs;
                recognitionLatency = Math.round(endTimeMs - startTimeMs);

                // Processar resultats
                if (results.gestures.length > 0) {
                    const gestureName = results.gestures[0][0].categoryName;
                    const response = gestureResponses[gestureName] || "ANÀLISI: Gesto desconegut o no definit.";
                    displayOutput(`[${gestureName}] - ${response}`);

                    // Actualitzar la posició del cub principal (p. ex., el centre de l'escena)
                    if (results.landmarks.length > 0 && cubeGroup) {
                        const handLandmark = results.landmarks[0][0]; // Primer punt (canell) de la primera mà
                        // Normalitza X/Y de 0-1 a coordenades 3D de la càmera (aprox. -10 a 10)
                        const x = (handLandmark.x - 0.5) * 2 * (window.innerWidth / window.innerHeight) * 12;
                        const y = -(handLandmark.y - 0.5) * 2 * 12; // Y invertida
                        const z = handLandmark.z * -10; // Utilitzem Z per profunditat (aprox. -10 a 0)

                        // Moure el grup de cubs basant-se en la posició de la mà
                        cubeGroup.position.lerp(new THREE.Vector3(x, y, z), 0.1);
                    }
                } else {
                    displayOutput("Esperant input. Mou la mà per iniciar la detecció.");
                    // Si no hi ha gestos, torna el cub a la posició central lentament
                    if (cubeGroup && THREE) {
                        cubeGroup.position.lerp(new THREE.Vector3(0, 0, 0), 0.05);
                    }
                }
            }
        }


        // --- BUCLE PRINCIPAL (ANIMACIÓ) ---

        /**
         * Bucle d'animació principal (cridat per requestAnimationFrame).
         * @param {number} timestamp - Temps actual.
         */
        function animate(timestamp) {
            requestAnimationFrame(animate);

            // 1. Càlcul de FPS (Estadístiques)
            const delta = timestamp - lastTimestamp;
            lastTimestamp = timestamp;
            if (delta > 0) {
                document.getElementById('fps-value').textContent = Math.round(1000 / delta);
                document.getElementById('latency-value').textContent = recognitionLatency;
            }

            // 2. Lògica de Reconeixement (Només si el reconeixedor està inicialitzat)
            if (recognizer) {
                recognizeGestures();
            }

            // 3. Animació 3D
            if (isCubesVisible && cubeGroup && renderer && scene && camera) {
                cubeGroup.rotation.y += 0.005;
                cubeGroup.rotation.x += 0.002;
                cubeGroup.children.forEach(cube => {
                    cube.rotation.x += 0.01;
                    cube.rotation.y += 0.005;
                    cube.material.opacity = 0.8 + Math.sin(timestamp * 0.001) * 0.1; // Efecte pulsant
                });
                renderer.render(scene, camera);
            }
        }

        // --- DEPENDÈNCIES I POLLING ---

        /**
         * Comprova si les llibreries globals s'han carregat i inicia la càrrega de MediaPipe.
         */
        async function checkDependencies() {
            const statusEl = document.getElementById('status-message');
            const isThreeLoaded = typeof THREE !== 'undefined';

            if (!isThreeLoaded) {
                 // Gestiona el retard de càrrega de Three.js (hauria de ser ràpid)
                 statusEl.textContent = `INICIALITZANT NUCLI NEURONAL . . . (Esperant: THREE.js)`;
                 setTimeout(checkDependencies, 200);
                 return;
            }

            // Si Three.js està carregat, continuem amb MediaPipe.
            if (!mpVision) {
                statusEl.textContent = "Carregant mòdul IA . . . (MediaPipe)";
                try {
                    // FIX: HEM CANVIAT vision.js per vision_bundle.js per evitar el 404
                    const VISION_URL = "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js";
                    const visionModule = await import(VISION_URL);
                    mpVision = visionModule; // Guarda totes les exportacions
                    
                    statusEl.textContent = "DEPENDÈNCIES CARREGADES. Iniciant el sistema...";
                    
                    // Inici de l'aplicació
                    initThree();
                    initAI();

                } catch (error) {
                    console.error("CONSOLE_ERROR: Error de càrrega dinàmica de MediaPipe. Detall:", error);
                    document.getElementById('status-message').textContent = "ERROR: No es pot carregar el mòdul IA (MediaPipe).";
                    document.getElementById('camera-message').textContent = "Comprova la consola per a errors de xarxa o de seguretat.";
                    document.querySelector('.spinner').style.display = 'none';
                }
            } else {
                 // Si ja està carregat (en cas de re-execució), inicia l'aplicació
                 initThree();
                 initAI();
            }
        }


        // --- CONTROLS D'INTERFÍCIE ---

        document.getElementById('toggle-cubes').addEventListener('click', () => {
            isCubesVisible = !isCubesVisible;
            if (cubeGroup) {
                cubeGroup.visible = isCubesVisible;
            }
            document.getElementById('toggle-cubes').textContent = isCubesVisible ? 'CUB: ON' : 'CUB: OFF';
            if (!isCubesVisible && renderer && scene && camera) {
                // Si els cubs s'apaguen, forcem un render per netejar la pantalla
                renderer.render(scene, camera);
            }
        });

        document.getElementById('toggle-webcam').addEventListener('click', () => {
            isWebcamVisible = !isWebcamVisible;
            if (video) {
                video.style.display = isWebcamVisible ? 'block' : 'none';
            }
            document.getElementById('toggle-webcam').textContent = isWebcamVisible ? 'WEBCAM: ON' : 'WEBCAM: OFF';
        });

        // --- INICI DE L'APLICACIÓ ---

        window.onload = function () {
            // Mostra el segell de versió quan es carrega la finestra
            const stampEl = document.getElementById('version-stamp');
            if (stampEl) {
                // Format desitjat: V25.12.03 12:24 (YY.MM.DD HH:mm)
                const datePart = VERSION_STAMP.substring(1, 9); 
                const timePart = VERSION_STAMP.substring(10); 
                
                // Extreu components de data (YY.MM.DD)
                const yearPart = datePart.substring(2, 4);
                const monthPart = datePart.substring(4, 6);
                const dayPart = datePart.substring(6, 8);
                
                // Extreu components de temps (HH:mm)
                const formattedTime = `${timePart.substring(0, 2)}:${timePart.substring(2, 4)}`;
                
                stampEl.textContent = `V${yearPart}.${monthPart}.${dayPart} ${formattedTime}`;
            }

            // Comença el procés de comprovació de dependències (Càrrega dinàmica)
            checkDependencies();
        }

    </script>
</body>
</html>
